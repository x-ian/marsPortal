NOTES ON INSTALLATION OF PFSENSE
================================

Installation
------------
pfSense requires a system with 2 physical network interfaces
Choose quick / default installation of pfSense
On the old Baobab servers the 64 Bit version AMD64 had some performance issues with PHP. Switching back to the i386 32 Bit version solved them.
During boot it might be necessary to disable ACPI via boot option (2) (https://doc.pfsense.org/index.php/Booting_Options#pfSense_2.0)
When booting from LiveCD stops in the middle of the boot process (or stops with a mount error as described here https://doc.pfsense.org/index.php/Boot_Troubleshooting), choose 'Boot from USB drive (option 3) at the first pfSense selection screen
When performing an installation to the hard disk from a bootable CD, pay attention to the messages and input screens. You need to press I at the beginning of the boot process when asked for input to invoke the installation, otherwise it will start the LiveCD after 10 seconds.
Once the installation and the copying process is done, remove the Boot CD before restarting. Otherwise it boots up again from the CD instead of the newly created installation on the hard disk.


Initial configuration
---------------------
Configure network interface em0 as WAN (e.g. with 172.16.1.X/24) and em1 as LAN (e.g. with 192.168.1.1/24 and DHCP services enabled)
Connect with a cable to the LAN port (em1), wait until your computer receives an IP address from the pfSense and open the web browser pointing to above http://192.168.1.1
Finish the installation wizard by following the instructions on the screen


Configuration
-------------
Enable remote access on WAN interface for SSH, web management through Admin - Advanced - Activate HTTPS for WebConfigurator and Enable SSH (Secure Shell)
Install 'freeradius2', 'ntop', 'squid3', 'lightsquid', 'mailreport' from 'system - packages - available packages'
stop service freeradius from status - services
Change and add network interfaces as needed, e.g. add vlan interfaces to em1 starting from 192.168.11.x upwards, don't forget to disable the parent interface for VLANs (e.g. em1)
Configure DHCP server for every inside network/VLAN interface as required (might require to configure the VLAN IP as the local DNS server within the DHCP server of every VLAN interface)
Enable transparent Squid for HTTP and activate logging
Enable Lightsquid reporting
Change default passwords in Web UI - System - User manager - admin
Adjust timezone if needed


Firewall
--------
Add firewall rule to allow ICMP pings
Add a default firewall rule for every inside network/VLAN interface allowing any protocol to pass
Add firewall rules on wan interface to allow traffic on port 3000 (for ntop)


Captive Portal
--------------
Create and enable new Captive portal zone on the internal LAN interfaces
Configure RADIUS server with RADIUS authentication
Set IP of primary RADIUS server to the daloRADIUS server
enable 'send RADIUS accounting packets' with 'interim updates'
enable 'RADIUS MAC authentication'
set 'MAC authentication secret' to radius
enable 'Use RADIUS Session-Timeout attributes'
MAC address format 'unformatted'
disable concurrent logins
add 172.16.1.0 as allowed IP addresses (to bypass captive portal registration and traffic accounting for local servers)
add other external hostname as allowed hostname in case they should be accessed without captive portal
Services - DNS forwarder - add new host override with host = pfsense, domain = mars, IP = 172.16.1.8 and description = to make pfsense.mars locally available (e.g. required for radcheck)
Enable all VLAN interfaces if available


Automatic pfSense mails
-----------------------
Go to System - Advanced - Notifications and enter
E-Mail server: smtp.gmail.com
SMTP Port of E-Mail server: 465
Secure SMTP Connection	Enable SMTP over SSL/TLS
Enable STARTTLS
From e-mail address: <...>
Notification E-Mail address: <...<>
Notification E-Mail auth username (optional): <...>
Notification E-Mail auth password: <specify password here>
Add 'Weekly Network Utilization' under Status - Email Reports with settings
weekly, on Sunday at 23:00
with RRD Graphs captive portal :: concurrent and a weekly time span and RRD Graph WAN :: Traffic


marsPortal Customization
------------------------
Login with SSH as root and run these statements in the shell (to get to the shell press 8)
# for AMD64 used 
#setenv PACKAGESITE ftp://ftp-archive.freebsd.org/pub/FreeBSD-Archive/ports/amd64/packages-8.3-release/Latest/
# for i386 use
setenv PACKAGESITE ftp://ftp-archive.freebsd.org/pub/FreeBSD-Archive/ports/i386/packages-8.3-release/Latest/
pkg_add -r curl
pkg_add -r wget
pkg_add -r bash
pkg_add -r python
pkg_add -r git
pkg_add -r p5-Net-SMTP-TLS

edit file /usr/local/lib/perl5/site_perl/5.12.4/Net/SMTP/TLS.pm and add a new line 370 $offset += $w; (e.g. with vi, then :369 $ a <RETURN> <TAB> <TAB> <TAB> $offset += $w; <ESC> :wq!) (http://www.perlmonks.org/?node_id=929055)

now reboot the system and log again in with SSH and run these commands

mkdir /home/client_activities_log
mkdir /home/local_backups
cd /home

TODO git clone https://github.com/x-ian/marsPortal.git

ln -s /usr/local/bin/bash /bin/bash
cp /home/marsPortal/config.txt.sample /home/marsPortal/config.txt

Now open config.txt and adjust the config values as needed

add these line to root crontab
@reboot /home/marsPortal/misc/send_gmail_after_startup.sh
59 23 * * Sun /home/marsPortal/misc/weekly_maintenance.sh
5 7 * * * /home/marsPortal/misc/monitor_network_devices.sh
50 23 * * * /home/marsPortal/misc/captiveportal-disconnect-all-users.sh
55 23 * * * /home/marsPortal/misc/daloradius-mail-statistics.sh


Additional notes
----------------
On some installations the local console is not shown - it stops with the 'bootup complete' message, unclear how to solve this: https://forum.pfsense.org/index.php?topic=34814.0. In my case the file /etc/ttys was corrupt and was replaced with a working file from another system. This file is checked in under misc/ttys.example of this Github project.

When temporarily deactivating a network interface to shutdown a certain area of the network, pfSense needs to be rebooted

Facebook DNS based blocking
1. Add Firewall Alias with URL Table pointing to http://172.16.1.2:8000/captiveportal-facebook_subnets.txt
2. Create schedule to include working hours
3. Add Floating Firewall Rules with Destination Alias name of Firewall Alias name of 1.
4. Optional: Update list of Facebook subnets once in a while with
     for ip in `whois -h whois.radb.net '!gAS32934' | grep /`; do echo $ip; done


Open issues
-----------
Possibly increase intervall of interim updates from pfSense NAS to radius server as it may create plenty of interim update messages https://redmine.pfsense.org/issues/1492
