NOTES ON INSTALLATION OF PFSENSE
================================

Installation
------------

pfSense requires a system with at least 2 physical network interfaces.

Booting the Live/Installer CD can be troublesome at times. Check the notes below if it doesn't automatically proceed.

When performing an installation to the hard disk from a bootable CD, pay attention to the messages and input screens. You need to press I at the beginning of the boot process when asked for input to invoke the installation, otherwise it will start the LiveCD after 10 seconds.

Choose quick / default installation of pfSense

Once the installation and the copying process is done, remove the Boot CD before restarting. Otherwise it might boot up again from the CD instead of the newly created installation on the hard disk.

Installation notes:
On the old Baobab servers the 64 Bit version AMD64 had some performance issues with PHP. Switching back to the i386 32 Bit version solved them.

During boot it might be necessary to disable ACPI via boot option (2) (https://doc.pfsense.org/index.php/Booting_Options#pfSense_2.0)

When booting from LiveCD stops in the middle of the boot process (or stops with a mount error as described here https://doc.pfsense.org/index.php/Boot_Troubleshooting), attach an external USB CD drive and coose 'Boot from USB drive' (option 3) at the first pfSense selection screen.


Initial configuration
---------------------

After rebooting the basic network configs need to be configured.

Skip VLAN configuration if not needed.

Configure first network interface (e.g. em0) as WAN (e.g. with 172.16.1.X/24) and em1 as LAN (e.g. with 192.168.1.1/24) and enable DHCP services per devices as needed.

Connect with a cable to the LAN port (e.g. em1), wait until your computer receives an IP address from the pfSense and open the web browser pointing to above http://192.168.1.1. Use admin/pfsense as username and password.

Finish the installation wizard by following the instructions on the screen.


Configuration
-------------

Enable remote access on WAN interface for SSH and web management through System - Admin Access - Advanced - Activate HTTPS for WebConfigurator and Enable SSH (Secure Shell)

Adjust timezone if needed

Change and add network interfaces as needed, e.g. add vlan interfaces to em1 starting from 192.168.11.x upwards, don't forget to disable the parent interface for VLANs (e.g. em1)

Configure/activate DHCP server for every inside network/VLAN interface as required

Set DHCP server lease time to 43200 (note that this must be greater than any Captive portal and RADIUS session timeouts)


Captive Portal
--------------

Create and enable new Captive portal zone labeled mars on the internal LAN interfaces

Configure RADIUS server with RADIUS authentication

Set IP of primary RADIUS server to the daloRADIUS server

enable 'send RADIUS accounting packets' with 'interim updates'

enable 'RADIUS MAC authentication'

set 'MAC authentication secret' to radius

enable 'Use RADIUS Session-Timeout attributes'

MAC address format 'default' (separated with colons)

disable concurrent logins

Use File manager of Captive portal to upload all files from setup-captiveportal/filemanager/*
Upload file setup-captiveportal/captive-portal_page.php as captive portal 'Portal page contents'

optional: add all local IP addresses and external hostnames as allowed systems where access should be possible without passing through the Captive Portal (to bypass captive portal registration and traffic accounting for local servers)


marsPortal Customization
------------------------

Copy marsPortal.tgz to pfsense, e.g. with scp marsPortal.tgz root@192.168.1.1:/home

Connect via SSH/Putty and execute these statements in the shell (press 8 to access the shell after initial login):
mkdir /home/client_activities_log
mkdir /home/local_backups
cd /home
tar xzf marsPortal.tgz
ln -s /usr/local/bin/bash /bin/bash
cp /home/marsPortal/config.txt.sample /home/marsPortal/config.txt
(crontab -l ; echo "@reboot /home/marsPortal/misc/send_gmail_after_startup.sh") | crontab -
(crontab -l ; echo "59 23 * * Sun /home/marsPortal/misc/weekly_maintenance.sh") | crontab -
(crontab -l ; echo "#5 7 * * * /home/marsPortal/misc/monitor_network_devices.sh") | crontab -
(crontab -l ; echo "#50 23 * * * /home/marsPortal/misc/captiveportal-disconnect-all-users.sh") | crontab -
(crontab -l ; echo "55 23 * * * /home/marsPortal/misc/daloradius-mail-statistics.sh") | crontab -

Now open /home/marsPortal/config.txt and adjust the config values as needed, e.g. with vi /home/marsPortal/config.txt


Configurations which require Internet access
--------------------------------------------

pfSense 2.2: https://doc.pfsense.org/index.php/Installing_FreeBSD_Packages
Login with SSH as root and run these statements in the shell (to get to the shell press 8) with a working Internet connection:
pkg
pkg update
pkg install bash
pkg install wget
pkg install p5-Net-SMTP-TLS
rehash

pfSense 2.1
Login with SSH as root and run these statements in the shell (to get to the shell press 8)
# for AMD64 used 
#setenv PACKAGESITE ftp://ftp-archive.freebsd.org/pub/FreeBSD-Archive/ports/amd64/packages-8.3-release/Latest/
# for i386 use
setenv PACKAGESITE ftp://ftp-archive.freebsd.org/pub/FreeBSD-Archive/ports/i386/packages-8.3-release/Latest/
pkg_add -r wget
pkg_add -r bash
pkg_add -r p5-Net-SMTP-TLS

Install 'freeradius2', 'ntop', 'squid3', 'lightsquid', 'mailreport' from 'system - packages - available packages'

Stop service freeradius from status - services

Enable transparent Squid for HTTP and activate logging

Enable Lightsquid reporting


Optional: Automatic pfSense mails
---------------------------------

Go to System - Advanced - Notifications and enter

E-Mail server: smtp.gmail.com

SMTP Port of E-Mail server: 465

Secure SMTP Connection	Enable SMTP over SSL/TLS

From e-mail address: <...>

Notification E-Mail address: <...<>

Notification E-Mail auth username (optional): <...>

Notification E-Mail auth password: <specify password here>

Add 'Weekly Network Utilization' under Status - Email Reports with settings
weekly, on Sunday at 23:00 with RRD Graphs captive portal :: concurrent and a weekly time span and RRD Graph WAN :: Traffic

Depending on the gmail account configuration you might need to enable 'less secure apps' for this gmail account 


Optional: Firewall
------------------

Add firewall rule to allow ICMP pings

Add firewall rules on wan interface to allow traffic on port 3000 (for ntop)


Additional notes
----------------

On some installations the local console is not shown - it stops with the 'bootup complete' message, unclear how to solve this: https://forum.pfsense.org/index.php?topic=34814.0. In my case the file /etc/ttys was corrupt and was replaced with a working file from another system. This file is available under docs/install - ttys.example.

When temporarily deactivating a network interface to shutdown a certain area of the network, pfSense needs to be rebooted


Unknown/unclear/open issues
---------------------------

Services - DNS forwarder - add new host override with host = pfsense, domain = mars, IP = 172.16.1.8 and description = to make pfsense.mars locally available (e.g. required for radcheck)

Enable all VLAN interfaces if available

edit file /usr/local/lib/perl5/site_perl/5.12.4/Net/SMTP/TLS.pm and add a new line 370 $offset += $w; (e.g. with vi, then :369 $ a <RETURN> <TAB> <TAB> <TAB> $offset += $w; <ESC> :wq!) (http://www.perlmonks.org/?node_id=929055)

Possibly increase intervall of interim updates from pfSense NAS to radius server as it may create plenty of interim update messages https://redmine.pfsense.org/issues/1492
