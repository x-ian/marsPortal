freeRADIUS Installation
=======================

pfSense requires an external freeRADIUS server to authenticate users/connected devices and account for their traffic volumes. 


MySQL installation
------------------

echo y | pkg install mysql56-server
rehash
cd /usr/local && ./bin/mysql_install_db # careful: creates mysql data dir under /usr/local
chown -R mysql /usr/local/data
echo "bind-address = 127.0.0.1" >> /usr/local/my.cnf
/usr/local/bin/mysqld_safe &
/usr/local/bin/mysql_secure_installation # follow instructions


freeRADIUS installation
-----------------------

echo y | pkg install freeradius
rehash
mysql -u root -pradius <<EOF
   CREATE DATABASE radius;
   GRANT ALL ON radius.* TO radius@localhost IDENTIFIED BY "radpass";
   exit
EOF
mysql -u root -p radius < /usr/local/etc/raddb/sql/mysql/schema.sql

# done by start script, just here for reference 
echo 'radiusd_enable="YES"' >> /etc/rc.conf
mkdir /var/run/radiusd/

To start the server in normal (daemon) mode, run:
/usr/local/etc/rc.d/radiusd [ start | stop | debug ]

uncomment $INCLUDE sql.conf in /usr/local/etc/raddb/radiusd.conf
uncomment relevant sql lines in/usr/local/etc/raddb/sites-enabled/default

'steal' rlm_sql_mysql.* from pfsense freeradius package (/usr/local/lib/freeradius-2.2.6/)
cd / && tar xzf root/freeradius-2.2.6-rlm_sql_mysql_amd64.tgz


Testing freeRADIUS install with local file-based users list
-----------------------------------------------------------
add 'testingUsers Cleartext-Password := "password"' to top of /usr/local/etc/raddb/users
radtest testingUsers password localhost 0 testing123

Testing freeRADIUS install with MySQL-based users list
------------------------------------------------------
# TODO: Doesn't work!
mysql -u root -pradius radius <<EOF
	INSERT INTO radcheck set username='testingSQL', value='password', op=':=';
EOF
radtest testingSQL password localhost 0 testing123


Configuration of freeRADIUS
---------------------------

Modify /usr/local/etc/raddb/sites-enabled/default as follows:

	# add to authorize section
	$INCLUDE    /home/marsPortal/freeradius-config/marsPortal.authorize
		
	# add to preacct section
	$INCLUDE    /home/marsPortal/freeradius-config/marsPortal.preacct
		
	# add to accounting section
	$INCLUDE    /home/marsPortal/freeradius-config/marsPortal.accounting

Add to /usr/local/etc/raddb/dictionary
$INCLUDE    /home/marsPortal/freeradius-config/marsPortal.dictionary

Run command and make sure the line 'Starting FreeRADIUS' ends with an OK: /usr/local/etc/rc.d/radiusd stop; /usr/local/etc/rc.d/radiusd debug


Manual configs
--------------

XXX Manually edit /etc/freeradius/sql.conf and change entry of num_sql_socks to 'num_sql_socks = 15'.

ln -s /home/marsPortal/freeradius-config/captiveportal-disconnect-user  /usr/local/etc/raddb/modules/captiveportal-disconnect-user

XXX
(crontab -l ; echo "#59 23 * * * /home/marsPortal/daloradius-accounting/reset-groups-open-for-today.sh") | crontab -
# open up network outside of work hours and at weekends
(crontab -l ; echo "0 17 * * 1-5 /home/marsPortal/daloradius-accounting/activate-groups-non-work-hours.sh") | crontab -
(crontab -l ; echo "0 8 * * 1-5 /home/marsPortal/daloradius-accounting/deactivate-groups-non-work-hours.sh") | crontab -

# run daily accounting for full day and work hours not excluding lunch
(crontab -l ; echo "5 0 * * * /home/marsPortal/daloradius-accounting/accounting-snapshot-beg-of-day.sh") | crontab -
(crontab -l ; echo "0 7 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-beg-of-work.sh") | crontab -
(crontab -l ; echo "9,19,29,39,49,59 7-17 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-end-of-work.sh") | crontab -
(crontab -l ; echo "5,15,25,35,45,55 1-23 * * * /home/marsPortal/daloradius-accounting/accounting-snapshot-end-of-day.sh") | crontab -

# daily accounting with respecting lunch hours during work days
# daily accounting starts at 00:15
(crontab -l ; echo "15 0 * * * /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh day_offset") | crontab 
# work day starts mo-fr 08:00
(crontab -l ; echo "0 8 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh work_offset") | crontab 
# lunch starts mo-fr 12:30
(crontab -l ; echo "30 12 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh lunch_offset") | crontab 
# lunch goes up to 13:30 mo-fr
(crontab -l ; echo "40,50 12 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh lunch_total") | crontab 
(crontab -l ; echo "0,10,20,30 13 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh lunch_total") | crontab 
# work goes up to 16:31 mo-fr
(crontab -l ; echo "1,11,21,31,41,51 8-15 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh work_total") | crontab 
(crontab -l ; echo "1,11,21,31 16 * * 1-5 /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh work_total") | crontab 
# daily accounting ends at 23:52
(crontab -l ; echo "2,12,22,32,42,52 1-23 * * * /home/marsPortal/daloradius-accounting/accounting-snapshot-v2.sh day_total") | crontab 

mysql -u radius -pradius radius <<EOF

DROP TABLE IF EXISTS daily_accounting;
CREATE TABLE daily_accounting (
  id int(32) NOT NULL AUTO_INCREMENT,
  username varchar(64) COLLATE utf8_unicode_ci NOT NULL,
  day date NOT NULL,
  day_beg datetime,
  inputoctets_day_beg bigint(20) DEFAULT 0,
  outputoctets_day_beg bigint(20) DEFAULT 0,
  work_beg datetime,
  inputoctets_work_beg bigint(20) DEFAULT 0,
  outputoctets_work_beg bigint(20) DEFAULT 0,
  work_end datetime,
  inputoctets_work_end bigint(20) DEFAULT 0,
  outputoctets_work_end bigint(20) DEFAULT 0,
  day_end datetime,
  inputoctets_day_end bigint(20) DEFAULT 0,
  outputoctets_day_end bigint(20) DEFAULT 0,
  PRIMARY KEY (id)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;
ALTER TABLE daily_accounting ADD UNIQUE INDEX (username, day);

INSERT INTO radgroupcheck (groupname, attribute, op, value) VALUES
('marsPortal-Template', 'mars-Input-Megabytes-Daily-Work-Hours', ':=', '250'),
('marsPortal-Template', 'mars-Output-Megabytes-Daily-Work-Hours', ':=', '250'),
('marsPortal-Template', 'mars-Input-Megabytes-Daily-Total', ':=', '500'),
('marsPortal-Template', 'mars-Output-Megabytes-Daily-Total', ':=', '500'),
('marsPortal-Template', 'mars-Max-Concurrent-Devices', ':=', '100');
INSERT INTO radgroupreply (groupname, attribute, op, value) VALUES
('marsPortal-Template', 'Session-Timeout', ':=', '43200'),
('marsPortal-Template', 'WISPr-Bandwidth-Max-Up', ':=', '512000'),
('marsPortal-Template', 'WISPr-Bandwidth-Max-Down', ':=', '512000');

INSERT INTO radgroupreply (groupname, attribute, op, value) VALUES
('marsPortal-Template-open-for-today', 'Session-Timeout', ':=', '43200'),
('marsPortal-Template-open-for-today', 'WISPr-Bandwidth-Max-Up', ':=', '512000'),
('marsPortal-Template-open-for-today', 'WISPr-Bandwidth-Max-Down', ':=', '512000');

INSERT INTO radgroupreply (groupname, attribute, op, value) VALUES
('marsPortal-Template-non-work-hours', 'Session-Timeout', ':=', '43200');

INSERT INTO radgroupcheck (groupname, attribute, op, value) VALUES
('No-Internet-Access', 'Auth-Type', ':=', 'Reject');
INSERT INTO radgroupreply (groupname, attribute, op, value) VALUES
('No-Internet-Access', 'Reply-Message', ':=', 'Your device is permanently disabled.');

INSERT INTO radgroupcheck (groupname, attribute, op, value) VALUES
('Users', 'mars-Input-Megabytes-Daily-Work-Hours', ':=', '250'),
('Users', 'mars-Output-Megabytes-Daily-Work-Hours', ':=', '100');
INSERT INTO radgroupreply (groupname, attribute, op, value) VALUES
('Users', 'Session-Timeout', ':=', '43200'),
('Users', 'WISPr-Bandwidth-Max-Up', ':=', '400000'),
('Users', 'WISPr-Bandwidth-Max-Down', ':=', '150000');


DROP TABLE IF EXISTS daily_accounting_v2;
CREATE TABLE daily_accounting_v2 (
  id int(32) NOT NULL AUTO_INCREMENT,
  username varchar(64) COLLATE utf8_unicode_ci NOT NULL,
  day date NOT NULL,

  day_offset datetime,
  day_offset_input bigint(20) DEFAULT 0,
  day_offset_output bigint(20) DEFAULT 0,

  work_offset datetime,
  work_offset_input bigint(20) DEFAULT 0,
  work_offset_output bigint(20) DEFAULT 0,

  lunch_offset datetime,
  lunch_offset_input bigint(20) DEFAULT 0,
  lunch_offset_output bigint(20) DEFAULT 0,

  lunch_total datetime,
  lunch_total_input bigint(20) DEFAULT 0,
  lunch_total_output bigint(20) DEFAULT 0,

  work_total datetime,
  work_total_input bigint(20) DEFAULT 0,
  work_total_output bigint(20) DEFAULT 0,

  day_total datetime,
  day_total_input bigint(20) DEFAULT 0,
  day_total_output bigint(20) DEFAULT 0,

  PRIMARY KEY (id)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;
ALTER TABLE daily_accounting_v2 ADD UNIQUE INDEX (username, day);
ALTER TABLE daily_accounting_v2 ADD INDEX (username);
ALTER TABLE daily_accounting_v2 ADD INDEX (day);

DROP TABLE IF EXISTS userinfo;
CREATE TABLE userinfo (
  id int(32) NOT NULL AUTO_INCREMENT,
  username varchar(64) COLLATE utf8_unicode_ci NOT NULL,
  firstname varchar(64),
  lastname varchar(64),
  email varchar(64),
  department varchar(64),
  organisation varchar(64),
  initial_ip varchar(64),
  hostname varchar(64),
  registration_date datetime,
  mac_vendor varchar(64),
  notes varchar(64),
  PRIMARY KEY (id)
) ENGINE=MyISAM DEFAULT CHARSET=latin1;
ALTER TABLE userinfo ADD UNIQUE INDEX (username);

EOF


Create user groups
------------------

Create new user groups as required, e.g. Users, Guests, Leadership. Easiest to duplicate the group marsPortal-Template.

For each of these groups the following attributes can be added to determine the characteristics of the group. Possible RADIUS attributes for each group are: 
- WISPr-Bandwidth-Max-Down, WISPr-Bandwidth-Max-Up
- Session-Timeout
- mars-Output-Megabytes-Daily-Work-Hours and mars-Input-Megabytes-Daily-Work-Hours
- mars-Output-Megabytes-Daily-Total and mars-Input-Megabytes-Daily-Total
- mars-Max-Concurrent-Devices
- Accept-Method: reject, optionally with Reply-Message

Optional: For every user group, create a matching XYZ-open-for-today group (these names are part of some automated scripts, so do not change this postfix). 


Finalizing
----------

Connect a client to LAN subnet of pfSense and daloRADIUS server and try to access any HTTP (not HTTPS) page. E.g. http://www.marsgeneral.com

Catch the MAC address from resulting error page and create new freeradius user with MAC authentication in the Web UI.

Try again to connect to a HTTP (!) page.

If everything worked out, you should be able to access this web page now. In that case a session on the pfSense is also created and visible from the menu Status - Captive Portal.

In case no Internet access is granted and no session is created on the captive portal, use the command line to troubleshoot the RADIUS communication. E.g. from the pfSense shell, invoke this command (change settings as needed):
radtest <mac address> radius localhost 0 radius

Receiving an Access-Reject packet indicates that something with the radius user entry or configuration doesn't match; receiving an Access-Accept packet while still not being able to access the Internet points towards a Captive Portal problem.
